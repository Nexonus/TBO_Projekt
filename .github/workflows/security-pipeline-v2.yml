#name: Beta security pipeline
#
#permissions:
#  contents: write
#  issues: write
#  checks: write
#  pull-requests: write
#
#on:
#  push:
#    branches-ignore: ["main"]
#
#jobs:
#  security-and-dynamic-scan:
#    runs-on: ubuntu-latest
#    steps:
#      - name: Checkout Code
#        uses: actions/checkout@v4
#        with:
#          fetch-depth: 0
#
#      - name: Gitleaks Secret Scan
#        uses: gitleaks/gitleaks-action@v2
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#          GITLEAKS_COMMAND: "detect"
#          GITLEAKS_LOG_OPTS: "--all --full-history"
#
#      - name: TruffleHog Secret Scan
#        uses: trufflesecurity/trufflehog@main
#        with:
#          path: ./
#          base: ""
#          extra_args: --results=verified,unknown --debug
#        continue-on-error: true
#
#      # --- 2. SAST ---
#      - name: Semgrep (Full Scan)
#        uses: semgrep/semgrep-action@v1
#        with:
#          config: >-
#            p/security-audit
#            p/secrets
#            p/csharp
#
#      # --- 3. SCA (Filesystem) ---
#      - name: Trivy FS (Scan all files/configs)
#        uses: aquasecurity/trivy-action@master
#        with:
#          scan-type: 'fs'
#          scan-ref: '.'
#          scanners: 'vuln,secret,config'
#
#      # --- 4. BUILD & PREPARE FOR DAST ---
#      - name: Build and Start Application
#        run: |
#          docker compose up -d --build
#          echo "Czekam na uruchomienie usÅ‚ug..."
#          sleep 15
#
#      - name: Wait for API to be ready
#        run: |
#          echo "Waiting for API..."
#          for i in {1..30}; do
#            if curl -s http://localhost:8080/ > /dev/null; then
#              echo "API is ready!"
#              break
#            fi
#            echo "Attempt $i/30..."
#            sleep 2
#          done
#
#      # --- 5. CONTAINER SECURITY ---
#      - name: Trivy Image Scan
#        uses: aquasecurity/trivy-action@master
#        with:
#          image-ref: apd.api:latest
#          format: 'table'
#          exit-code: '1'
#          ignore-unfixed: true
#          vuln-type: 'os,library'
#
##      - name: Set permissions for ZAP workspace # NEW STEP ADDED HERE
##        run: |
##          # Grant full permissions to the GitHub Actions workspace directory
##          # This resolves 'Permission denied: /zap/wrk/zap.yaml'
##          chmod -R 777 ${{ github.workspace }}
#
#      # --- 6. DAST (OWASP ZAP) ---
#      - name: OWASP ZAP Baseline Scan
#        uses: zaproxy/action-baseline@v0.12.0
#        with:
#          target: 'http://localhost:8080'
#          cmd_options: '-a'
#          fail_action: true
#          allow_issue_writing: false # Disable creating issues (TODO: to be deleted when issues creation will be available)
#          artifact_name: 'zap-scan-results'
#          token: ${{ github.token }}
#
#      - name: Stop Application Services
#        if: always()
#        run: docker compose down